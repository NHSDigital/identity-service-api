parameters:
  - name: service_name
    type: string

steps:
  - bash: |
      pip install virtualenv
      virtualenv test_env
      ./test_env/scripts/activate
      pip install -r requirements.txt
    workingDirectory: $(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/api_tests
    displayName: Setup Tests

  - bash: |
      export BASE_URL="https://nhsd-apim-testing-$(APIGEE_ENVIRONMENT).herokuapp.com"
      export CLIENT_ID=""
      export CLIENT_SECRET=""
      export REDIRECT_URI=""
      export AUTHENTICATE_URL=""
      export AUTHENTICATE_USERNAME=""
      export AUTHENTICATE_PASSWORD=""
      export APIGEE_CLIENT_ID=""
      export API_URL=""

      pytest -v tests/ --junitxml=test-report.xml
    workingDirectory: $(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/api_tests
    displayName: Run Integration Tests

  - task: PublishTestResults@2
    displayName: 'Publish Test Results'
    inputs:
      testResultsFiles: '$(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/api_tests/test-report.xml'
      failTaskOnFailedTests: true
