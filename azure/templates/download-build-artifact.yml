parameters:
  - name: serviceName
    type: string
  - name: artifactBuildId
    type: string
  - name: artifactBranch
    type: string
  - name: pipelineAlias
    type: string

steps:
  - download: none
  - bash: |
      if [[ "${{ parameters.artifactBranch }}" =~ ^v ]];
      then
        export TYPE="tags";
      else
        export TYPE="heads";
      fi
      echo "##vso[task.setvariable variable=GIT_BRANCH_TYPE]$TYPE";

      if [[ "${{ parameters.artifactBranch }}" =~ ^refs\/tags\/v ]];
      then
        export ARTIFACT_BRANCH="ref/heads/master";
      else
        export ARTIFACT_BRANCH="${{ parameters.artifactBranch }}";
      fi
      echo "##vso[task.setvariable variable=ARTIFACT_BRANCH]$ARTIFACT_BRANCH";

      echo "Retrieving Artifact from: $ARTIFACT_BRANCH BuildId: ${{ parameters.artifactBuildId }}"
    displayName: Determine Artifact Location
  - task: DownloadPipelineArtifact@2
    displayName: 'Download Build Artifact'
    inputs:
      source: 'specific'
      project: '$(resources.pipeline.${{ parameters.pipelineAlias }}.projectID)'
      definition: '$(resources.pipeline.${{ parameters.pipelineAlias }}.pipelineID)'
      preferTriggeringPipeline: true
      ${{ if eq(parameters.artifactBuildId, 'latest') }}:
        buildVersionToDownload: 'latestFromBranch'
      ${{ if ne(parameters.artifactBuildId, 'latest') }}:
        buildVersionToDownload: 'specific'
        runId: '${{ parameters.artifactBuildId }}'
      ${{ if eq('$(ARTIFACT_BRANCH)', '$(Build.SourceBranch)') }}:
        branchName: '$(Build.SourceBranch)'
      ${{ if ne('$(ARTIFACT_BRANCH)', '$(Build.SourceBranch)') }}:
        branchName: 'refs/$(GIT_BRANCH_TYPE)/${{ parameters.artifactBranch }}'
      downloadPath: '$(Pipeline.Workspace)/${{ parameters.serviceName }}'
