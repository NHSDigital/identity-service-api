steps:
  - task: DownloadSecureFile@1
    name: aws_config
    inputs:
      secureFile: ptl_aws_config
  
  - bash: |
      mkdir -p ~/.aws
      mv $(aws_config.secureFilePath) ~/.aws/config
      chmod 400 ~/.aws/config
    displayName: "Get AWS config"
  
  - bash: |
      set -euo pipefail
      
      for secret_name in APIGEE_OTP_KEY \
                         APIGEE_PASSWORD \
                         ; do
          secret_id="$(aws-label-ptl-or-prod)/azure-devops/$(aws-label-apigee-org)/${secret_name}"
          secret_details=$(aws --profile apm_ptl secretsmanager get-secret-value --secret-id ${secret_id})
          secret_value=$(echo $secret_details | jq -re .SecretString)
          echo "##vso[task.setvariable variable=${secret_name};issecret=true]${secret_value}";
          unset secret_id secret_details secret_value
      done
    displayName: 'Get AWS secrets'
  
  - bash: |
      set -euo pipefail
      
      export SERVICE_ARTIFACT_NAME=`ls $(Pipeline.Workspace)/$(SERVICE_NAME)`
      echo "##vso[task.setvariable variable=SERVICE_ARTIFACT_NAME]$SERVICE_ARTIFACT_NAME"
  
      # AWS cli can handle getting up to 10 params in a single call.
      params=$(aws --profile apm_ptl ssm get-parameters --names \
                /$(aws-label-ptl-or-prod)/azure-devops/$(aws-label-apigee-org)/APIGEE_USERNAME \
                /$(aws-label-ptl-or-prod)/azure-devops/$(aws-label-apigee-org)/APIGEE_ORGANIZATION \
                /$(aws-label-ptl-or-prod)/azure-devops/$(aws-label-apigee-env)/APIGEE_ENVIRONMENT \
                /$(aws-label-ptl-or-prod)/azure-devops/$(aws-label-apigee-env)/ENV_URL \
                /$(aws-label-ptl-or-prod)/azure-devops/$(aws-label-apigee-env)/IDENTITY_URL \
                | jq -cre .Parameters[]);
      for param in ${params}; do
          _apply_param() {
              # name_parts is an array strings from splitting aws param path on forward-slash
              local name_parts=( $(echo $param | jq -cre .Name | tr "/" " ") )
              # name is the final string of that array
              local name=${name_parts[$((${#name_parts[@]} - 1))]}
              local value=$(echo $param | jq -cre .Value)
              echo "##vso[task.setvariable variable=${name}]${value}"
          }
          _apply_param
      done
    displayName: 'Get AWS SSM parameters'
