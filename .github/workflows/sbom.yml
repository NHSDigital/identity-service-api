name: SBOM Check

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Apply SBOM check"
        required: true
        type: choice
        options:
          - apply
          - skip
        default: apply

jobs:
  sbom-check:
    if: ${{ github.event.inputs.environment == 'apply' }}
    name: Software Bill of Materials
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: ./
          format: cyclonedx-json
          artifact-name: identity-repo-sbom.cdx.json
          
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-action-${{ github.run_id }}
          path: /tmp/sbom-action-*/identity-repo-sbom.cdx.json
          if-no-files-found: warn

      - name: Clean up SBOM file
        run: rm /tmp/sbom-action-*/identity-repo-sbom.cdx.json || true

