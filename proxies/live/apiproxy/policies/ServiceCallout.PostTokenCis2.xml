<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<ServiceCallout async="false" continueOnError="false" enabled="true" name="ServiceCallout.PostTokenCis2">
  <Request>
    <Set>
      <Headers>
          <Header name="Content-Type">application/x-www-form-urlencoded</Header>
      </Headers>
      <FormParams>
          <FormParam name="grant_type">authorization_code</FormParam>
          <FormParam name="code">{request.queryparam.code}</FormParam>
          <!-- CHANGE REDIRECT_URI TO VAR -->
        <FormParam name="redirect_uri">https://internal-dev.api.service.nhs.uk/oauth2-pr-256/callback</FormParam>
        <FormParam name="client_secret">{private.apigee.client_secret}</FormParam>
        <FormParam name="client_id">{identity-service-config.cis2.client_id}</FormParam>
      </FormParams>
      <Verb>POST</Verb>
    </Set>
  </Request>
  <Response>TokenResponse</Response>
  <HTTPTargetConnection>
    <SSLInfo>
      <Enabled>true</Enabled>
    </SSLInfo>
    <LoadBalancer>
      <Server name="{{ IDENTITY_PROVIDER_CIS2 }}" />
    </LoadBalancer>
    <Path>{identity-service-config.cis2.access_token_path}</Path>
  </HTTPTargetConnection>
</ServiceCallout>
